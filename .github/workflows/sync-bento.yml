name: Sync Bento Tools

on:
  push:
    branches: [main]
    paths: ['bentotools/**']

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/latest/download/sops-v3.8.1.linux
          chmod +x sops-v3.8.1.linux && sudo mv sops-v3.8.1.linux /usr/local/bin/sops

      - name: Decrypt secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          echo "üîê Decrypting secrets..."
          if [ -z "$SOPS_AGE_KEY" ] || [ ! -f secrets.encrypted.yaml ]; then
            echo "‚ö†Ô∏è SOPS_AGE_KEY not set or secrets.encrypted.yaml missing"
            exit 1
          fi
          echo "$SOPS_AGE_KEY" > /tmp/age-key.txt
          export SOPS_AGE_KEY_FILE=/tmp/age-key.txt
          sops -d secrets.encrypted.yaml > secrets.yaml
          rm -f /tmp/age-key.txt

      - name: Export secrets as env vars
        run: |
          echo "üìã Exporting secrets as environment variables..."
          # Convert YAML key: value to export statements
          while IFS=: read -r key value; do
            # Skip comments and empty lines
            [[ "$key" =~ ^[[:space:]]*# ]] && continue
            [[ -z "$key" ]] && continue
            # Trim whitespace and remove quotes
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^"//;s/"$//')
            # Export to GITHUB_ENV for subsequent steps
            echo "${key}=${value}" >> $GITHUB_ENV
          done < secrets.yaml
          echo "‚úì Secrets exported"

      - name: Pull on server
        if: env.SERVER_IP != '' && env.SSH_PRIVATE_KEY != ''
        run: |
          echo "üîÑ Pulling bentotools on server..."
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key && chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@"$SERVER_IP" '
            if [ -d /opt/bento-sync/.git ]; then
              cd /opt/bento-sync
              git fetch origin && git pull origin main || echo "‚ö†Ô∏è Pull failed"
              bun install || echo "‚ö†Ô∏è Install failed"
            fi
          '
          rm -f ~/.ssh/deploy_key

      - name: Sync streams
        env:
          TOOLS_ROOT_GITHUB: https://github.com/${{ github.repository }}/${{ github.ref_name }}/bentotools
        run: |
          echo "üîÑ Syncing Bento streams..."
          bun bentotools/sync.ts
