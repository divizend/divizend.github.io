name: Sync Bento Tools

on:
  push:
    branches:
      - main
    paths:
      - 'bentotools/**'
  workflow_dispatch:
    inputs:
      tools_root_github:
        description: 'TOOLS_ROOT_GITHUB (e.g., https://github.com/divizend/divizend.github.io/main/bentotools)'
        required: false
        type: string
  repository_dispatch:
    types: [bento-sync]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/latest/download/sops-v3.8.1.linux
          chmod +x sops-v3.8.1.linux
          sudo mv sops-v3.8.1.linux /usr/local/bin/sops

      - name: Decrypt secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          echo "$SOPS_AGE_KEY" > /tmp/age-key.txt
          export SOPS_AGE_KEY_FILE=/tmp/age-key.txt
          sops -d secrets.encrypted.yaml > secrets.yaml || {
            echo "âš ï¸ Failed to decrypt secrets.encrypted.yaml"
            echo "âš ï¸ Using default/empty values. Check SOPS_AGE_KEY secret."
            echo "BENTO_API_URL: ${BENTO_API_URL:-http://localhost:4195}" > secrets.yaml
            echo "S2_BASIN: ${S2_BASIN:-}" >> secrets.yaml
            echo "BASE_DOMAIN: ${BASE_DOMAIN:-}" >> secrets.yaml
            echo "S2_ACCESS_TOKEN: ${S2_ACCESS_TOKEN:-}" >> secrets.yaml
            echo "RESEND_API_KEY: ${RESEND_API_KEY:-}" >> secrets.yaml
          }
          rm -f /tmp/age-key.txt

      - name: Parse TOOLS_ROOT_GITHUB
        id: parse_tools_root
        run: |
          # Get TOOLS_ROOT_GITHUB from input or environment
          TOOLS_ROOT_GITHUB="${{{ inputs.tools_root_github }}}"
          if [ -z "$TOOLS_ROOT_GITHUB" ]; then
            # Default to current repo
            TOOLS_ROOT_GITHUB="https://github.com/${{ github.repository }}/${{ github.ref_name }}/bentotools"
          fi
          
          echo "tools_root_github=$TOOLS_ROOT_GITHUB" >> $GITHUB_OUTPUT
          echo "ðŸ” TOOLS_ROOT_GITHUB: $TOOLS_ROOT_GITHUB"
          
          # Parse to extract components
          if [[ "$TOOLS_ROOT_GITHUB" =~ ^https://github\.com/([^/]+)/([^/]+)(/([^/]+))?(/(.*))?$ ]]; then
            OWNER="${BASH_REMATCH[1]}"
            REPO="${BASH_REMATCH[2]}"
            BRANCH="${BASH_REMATCH[4]}"
            PATH_PART="${BASH_REMATCH[6]}"
            
            echo "owner=$OWNER" >> $GITHUB_OUTPUT
            echo "repo=$REPO" >> $GITHUB_OUTPUT
            echo "branch=${BRANCH:-}" >> $GITHUB_OUTPUT
            echo "path=${PATH_PART:-}" >> $GITHUB_OUTPUT
          else
            echo "âŒ Invalid TOOLS_ROOT_GITHUB format"
            exit 1
          fi

      - name: Get default branch if not specified
        id: default_branch
        if: steps.parse_tools_root.outputs.branch == ''
        run: |
          OWNER="${{ steps.parse_tools_root.outputs.owner }}"
          REPO="${{ steps.parse_tools_root.outputs.repo }}"
          
          DEFAULT_BRANCH=$(curl -s "https://api.github.com/repos/${OWNER}/${REPO}" | jq -r '.default_branch // "main"')
          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ Default branch: $DEFAULT_BRANCH"

      - name: Load decrypted secrets
        id: secrets
        run: |
          # Load secrets from decrypted file
          if [ -f secrets.yaml ]; then
            BENTO_API_URL=$(grep "^BENTO_API_URL:" secrets.yaml | cut -d' ' -f2- | tr -d '"' || echo "http://localhost:4195")
            S2_BASIN=$(grep "^S2_BASIN:" secrets.yaml | cut -d' ' -f2- | tr -d '"' || echo "")
            BASE_DOMAIN=$(grep "^BASE_DOMAIN:" secrets.yaml | cut -d' ' -f2- | tr -d '"' || echo "")
            S2_ACCESS_TOKEN=$(grep "^S2_ACCESS_TOKEN:" secrets.yaml | cut -d' ' -f2- | tr -d '"' || echo "")
            RESEND_API_KEY=$(grep "^RESEND_API_KEY:" secrets.yaml | cut -d' ' -f2- | tr -d '"' || echo "")
            
            echo "bento_api_url=${BENTO_API_URL}" >> $GITHUB_OUTPUT
            echo "s2_basin=${S2_BASIN}" >> $GITHUB_OUTPUT
            echo "base_domain=${BASE_DOMAIN}" >> $GITHUB_OUTPUT
            echo "s2_access_token=${S2_ACCESS_TOKEN}" >> $GITHUB_OUTPUT
            echo "resend_api_key=${RESEND_API_KEY}" >> $GITHUB_OUTPUT
          else
            echo "bento_api_url=http://localhost:4195" >> $GITHUB_OUTPUT
            echo "s2_basin=" >> $GITHUB_OUTPUT
            echo "base_domain=" >> $GITHUB_OUTPUT
            echo "s2_access_token=" >> $GITHUB_OUTPUT
            echo "resend_api_key=" >> $GITHUB_OUTPUT
          fi

      - name: Compile and sync Bento streams
        env:
          BENTO_API_URL: ${{ steps.secrets.outputs.bento_api_url }}
          TOOLS_ROOT_GITHUB: ${{ steps.parse_tools_root.outputs.tools_root_github }}
          S2_BASIN: ${{ steps.secrets.outputs.s2_basin }}
          BASE_DOMAIN: ${{ steps.secrets.outputs.base_domain }}
          S2_ACCESS_TOKEN: ${{ steps.secrets.outputs.s2_access_token }}
          RESEND_API_KEY: ${{ steps.secrets.outputs.resend_api_key }}
        run: |
          echo "ðŸ”„ Syncing Bento streams from ${TOOLS_ROOT_GITHUB}..."
          
          # Use the TypeScript sync script
          chmod +x bentotools/sync.ts
          bun bentotools/sync.ts || {
            echo "âš ï¸ Sync script failed, but continuing..."
            exit 0
          }

      - name: Output summary
        if: always()
        run: |
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **TOOLS_ROOT_GITHUB**: ${{ steps.parse_tools_root.outputs.tools_root_github }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ steps.parse_tools_root.outputs.owner }}/${{ steps.parse_tools_root.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ steps.parse_tools_root.outputs.branch || steps.default_branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: ${{ steps.parse_tools_root.outputs.path || '/' }}" >> $GITHUB_STEP_SUMMARY
