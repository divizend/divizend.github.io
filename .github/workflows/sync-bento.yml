name: Sync Bento Tools

on:
  push:
    branches: [main]
    paths: ['bentotools/**']

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/latest/download/sops-v3.8.1.linux
          chmod +x sops-v3.8.1.linux && sudo mv sops-v3.8.1.linux /usr/local/bin/sops

      - name: Decrypt secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          echo "üîê Decrypting secrets..."
          if [ -z "$SOPS_AGE_KEY" ] || [ ! -f secrets.encrypted.yaml ]; then
            echo "‚ö†Ô∏è SOPS_AGE_KEY not set or secrets.encrypted.yaml missing"
            exit 1
          fi
          echo "$SOPS_AGE_KEY" > /tmp/age-key.txt
          export SOPS_AGE_KEY_FILE=/tmp/age-key.txt
          sops -d secrets.encrypted.yaml > secrets.yaml
          rm -f /tmp/age-key.txt

      - name: Load secrets
        id: secrets
        run: |
          echo "üìã Loading secrets..."
          BENTO_API_URL=$(grep -E "^BENTO_API_URL:" secrets.yaml | sed 's/^BENTO_API_URL:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "http://localhost:4195")
          S2_BASIN=$(grep -E "^S2_BASIN:" secrets.yaml | sed 's/^S2_BASIN:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "")
          BASE_DOMAIN=$(grep -E "^BASE_DOMAIN:" secrets.yaml | sed 's/^BASE_DOMAIN:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "")
          S2_ACCESS_TOKEN=$(grep -E "^S2_ACCESS_TOKEN:" secrets.yaml | sed 's/^S2_ACCESS_TOKEN:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "")
          RESEND_API_KEY=$(grep -E "^RESEND_API_KEY:" secrets.yaml | sed 's/^RESEND_API_KEY:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "")
          SERVER_IP=$(grep -E "^SERVER_IP:" secrets.yaml | sed 's/^SERVER_IP:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "")
          SSH_PRIVATE_KEY=$(grep -E "^SSH_PRIVATE_KEY:" secrets.yaml | sed 's/^SSH_PRIVATE_KEY:[[:space:]]*//' | sed 's/^"//;s/"$//' || echo "")
          
          echo "bento_api_url=${BENTO_API_URL}" >> $GITHUB_OUTPUT
          echo "s2_basin=${S2_BASIN}" >> $GITHUB_OUTPUT
          echo "base_domain=${BASE_DOMAIN}" >> $GITHUB_OUTPUT
          echo "s2_access_token=${S2_ACCESS_TOKEN}" >> $GITHUB_OUTPUT
          echo "resend_api_key=${RESEND_API_KEY}" >> $GITHUB_OUTPUT
          echo "server_ip=${SERVER_IP}" >> $GITHUB_OUTPUT
          echo "ssh_private_key=${SSH_PRIVATE_KEY}" >> $GITHUB_OUTPUT

      - name: Pull on server
        if: steps.secrets.outputs.server_ip != '' && steps.secrets.outputs.ssh_private_key != ''
        env:
          SERVER_IP: ${{ steps.secrets.outputs.server_ip }}
          SSH_PRIVATE_KEY: ${{ steps.secrets.outputs.ssh_private_key }}
        run: |
          echo "üîÑ Pulling bentotools on server..."
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key && chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@"$SERVER_IP" '
            if [ -d /opt/bento-sync/.git ]; then
              cd /opt/bento-sync
              git fetch origin && git pull origin main || echo "‚ö†Ô∏è Pull failed"
              bun install || echo "‚ö†Ô∏è Install failed"
            fi
          '
          rm -f ~/.ssh/deploy_key

      - name: Sync streams
        env:
          BENTO_API_URL: ${{ steps.secrets.outputs.bento_api_url }}
          TOOLS_ROOT_GITHUB: https://github.com/${{ github.repository }}/${{ github.ref_name }}/bentotools
          S2_BASIN: ${{ steps.secrets.outputs.s2_basin }}
          BASE_DOMAIN: ${{ steps.secrets.outputs.base_domain }}
          S2_ACCESS_TOKEN: ${{ steps.secrets.outputs.s2_access_token }}
          RESEND_API_KEY: ${{ steps.secrets.outputs.resend_api_key }}
        run: |
          echo "üîÑ Syncing Bento streams..."
          bun bentotools/sync.ts
